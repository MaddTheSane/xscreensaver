/*
 * Imakefile file for xscreensaver, Copyright (c) 1991-1997 Jamie Zawinski.
 *
 * You should not need to edit this file; edit config.h instead.
 *
 */

#include "config.h"

     SUB_MAKEFILES = utils/Makefile driver/Makefile hacks/Makefile \
		     hacks/glx/Makefile
          TARFILES = README Imakefile config.h screenblank.txt cde.txt
               TAR = gtar
          COMPRESS = gzip --verbose --best
      COMPRESS_EXT = gz
/**/#     COMPRESS = compress
/**/# COMPRESS_EXT = Z

all::
	@echo ""							    ; \
  echo ""								    ; \
  echo "                               ALERT!"				    ; \
  echo ""								    ; \
  echo "        ==========================================================" ; \
  echo ""								    ; \
  echo "        Did you read and edit config.h?  config.h is your friend."  ; \
  echo "        If you didn't, and you get compilation errors, that's why." ; \
  echo ""								    ; \
  echo "        ==========================================================" ; \
  echo ""

all:: $(SUB_MAKEFILES)
	cd utils  ; $(MAKE) $@ CC="$(CC)" CCOPTIONS="$(CCOPTIONS)" \
		CDEBUGFLAGS="$(CDEBUGFLAGS)"
	cd driver ; $(MAKE) $@ CC="$(CC)" CCOPTIONS="$(CCOPTIONS)" \
		CDEBUGFLAGS="$(CDEBUGFLAGS)"
	cd hacks  ; $(MAKE) $@ CC="$(CC)" CCOPTIONS="$(CCOPTIONS)" \
		CDEBUGFLAGS="$(CDEBUGFLAGS)"
	cd hacks/glx  ; $(MAKE) $@ CC="$(CC)" CCOPTIONS="$(CCOPTIONS)" \
		CDEBUGFLAGS="$(CDEBUGFLAGS)"

clean depend install install.man:: $(SUB_MAKEFILES)
	cd utils  ; $(MAKE) $@ BINDIR=$(BINDIR) XAPPLOADDIR=$(XAPPLOADDIR)
	cd driver ; $(MAKE) $@ BINDIR=$(BINDIR) XAPPLOADDIR=$(XAPPLOADDIR)
	cd hacks  ; $(MAKE) $@ BINDIR=$(BINDIR) XAPPLOADDIR=$(XAPPLOADDIR)
	cd hacks/glx ; $(MAKE) $@ BINDIR=$(BINDIR) XAPPLOADDIR=$(XAPPLOADDIR)

clean::
	$(RM) $(SUB_MAKEFILES)

Makefiles:: $(SUB_MAKEFILES)

utils/Makefile: utils/Imakefile config.h
	cd utils  ; $(IMAKE_CMD) -DTOPDIR=$(TOP) -DCURDIR=$(CURRENT_DIR)/utils
driver/Makefile: driver/Imakefile config.h
	cd driver ; $(IMAKE_CMD) -DTOPDIR=$(TOP) -DCURDIR=$(CURRENT_DIR)/driver
hacks/Makefile: hacks/Imakefile config.h
	cd hacks  ; $(IMAKE_CMD) -DTOPDIR=$(TOP) -DCURDIR=$(CURRENT_DIR)/hacks
hacks/glx/Makefile: hacks/glx/Imakefile config.h
	cd hacks/glx ; $(IMAKE_CMD) -DTOPDIR=$(TOP) -DCURDIR=$(CURRENT_DIR)/hacks/glx

/* This really makes me sick... */
tar: utils/Makefile driver/Makefile hacks/Makefile hacks/glx/Makefile
	@NAME=`sed -n							    \
  's/[^0-9]*\([0-9]\.[0-9][0-9]*\).*/xscreensaver-\1/p' utils/version.h` ;  \
  rm -f $$NAME ; ln -s . $$NAME ;					    \
  FILES= ;								    \
  for subdir in driver utils hacks hacks/glx ; do			    \
    d=`pwd` ;								    \
    cd $$subdir ;							    \
    FILES="$$FILES `$(MAKE) echo_tarfiles				    \
      | grep -v '^.*make\['						    \
      | sed \"s|^|$$subdir/|g;s| | $$subdir/|g\"			    \
      ` ";								    \
    cd $$d ; done ;							    \
  echo creating tar file $${NAME}.tar.$(COMPRESS_EXT)... ;		    \
  $(TAR) -vchf -							    \
    `echo $(TARFILES) $$FILES | sed "s|^|$$NAME/|g; s| | $$NAME/|g" `	    \
   | $(COMPRESS) > $${NAME}.tar.$(COMPRESS_EXT) ;			    \
  rm $$NAME
